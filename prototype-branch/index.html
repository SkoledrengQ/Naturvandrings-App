<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prototype ‚Äì Naturvandringsapp</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100%; }
    .leaflet-control button {
      background: white; border: 1px solid #ccc; border-radius: 6px;
      padding: 6px 10px; cursor: pointer; font-size: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,.2);
    }
    .popup h3 { margin: 4px 0 6px; font-size: 16px; }
    .popup p { margin: 0 0 8px; line-height: 1.35; }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // 1) Initier kort (center justeres efter vi har loadet POIs)
    const map = L.map('map');
    const tiles = L.tileLayer(
      'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
      { attribution: '&copy; OpenStreetMap contributors' }
    ).addTo(map);

    // 2) (Valgfrit) en lille "centr√©r p√• mig"-knap
    const locateCtrl = L.control({ position: 'topleft' });
    locateCtrl.onAdd = function () {
      const div = L.DomUtil.create('div', 'leaflet-control');
      div.innerHTML = '<button id="centerMe">üìç Centr√©r p√• mig</button>';
      return div;
    };
    locateCtrl.addTo(map);

    function centerOnUser() {
      if (!navigator.geolocation) {
        alert("Din browser underst√∏tter ikke geolocation.");
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude, accuracy } = pos.coords;
          const m = L.marker([latitude, longitude]).addTo(map)
            .bindPopup(`Din position<br>~${Math.round(accuracy)} m`).openPopup();
          map.setView([latitude, longitude], 16);
        },
        err => alert("Kunne ikke f√• position: " + err.message),
        { enableHighAccuracy: true, timeout: 8000, maximumAge: 2000 }
      );
    }
    // Aktiver knappen n√•r DOM er klar
    setTimeout(() => {
      const btn = document.getElementById('centerMe');
      if (btn) btn.onclick = centerOnUser;
    }, 0);

    // 3) Hent POIs og tegn dem
    fetch('pois.json')
      .then(r => {
        if (!r.ok) throw new Error('Kunne ikke hente pois.json');
        return r.json();
      })
      .then(pois => {
        const latlngs = [];

        pois.forEach(p => {
          if (typeof p.lat !== 'number' || typeof p.lon !== 'number') return; // skip hvis fejl
          const marker = L.marker([p.lat, p.lon]).addTo(map);
          const title = p.title ? `<h3>${escapeHtml(p.title)}</h3>` : '';
          const text = p.text ? `<p>${escapeHtml(p.text).replace(/\n\n/g, '<br/><br/>')}</p>` : '';
          marker.bindPopup(`<div class="popup">${title}${text}</div>`);
          latlngs.push([p.lat, p.lon]);
        });

        if (latlngs.length) {
          const bounds = L.latLngBounds(latlngs);
          map.fitBounds(bounds.pad(0.2)); // lidt luft rundt om punkterne
        } else {
          // fallback: zoom til DK som helhed
          map.setView([56.0, 10.0], 6);
        }
      })
      .catch(err => {
        console.error(err);
        map.setView([56.0, 10.0], 6);
      });

    // Lille helper til at undg√• HTML-injektion i popup
    function escapeHtml(s) {
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }
  </script>
</body>
</html>
